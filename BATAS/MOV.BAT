IF %MODE%==CLEAN GOTO :EOF

CALL ISREG16 %1
IF %RESULT%==1 GOTO :REG16
CALL ISREG8 %1
IF %RESULT%==1 GOTO :REG8
CALL ISMRM16 %1
IF %RESULT%==1 GOTO :MRM
CALL ISREGSEG %1 
IF %RESULT%==1 GOTO :REGSEG
ECHO Expected register, ModR/M or segment register (IP=%IP%)

:REG16
IF x%2==xWORD GOTO :R16IMM
IF x%1x%2==xAXx[WORD] GOTO :AXADDR
CALL ISREGSEG %2
IF %RESULT%==1 GOTO :MRM2SEG
CALL ISMRM16 %2
IF %RESULT%==1 GOTO :R16MRM
ECHO Expected immediate, ModR/M or segment register in second operand (IP=%IP%)

:R16IMM
CALL RPN! _%IP%_3+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
CALL CREG16 %1
CALL RPN! _184_%REG%+
CALL EMITBYTE %RESULT%
CALL EMITWORD %3
GOTO :EOF

:AXADDR
CALL RPN! _%IP%_3+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
CALL EMITBYTE 161
CALL EMITWORD %3
GOTO :EOF

:R16MRM
CALL CMRM16 %2
CALL RPN! _%IP%_2+_%DISPBYTES%+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
IF NOT %DISPBYTES%==1 GOTO :NOCHECK1
CALL IS8SIGN %3
IF %RESULT%==1 GOTO :NOCHECK1
ECHO Byte displacement truncated (IP=%IP%)
:NOCHECK1
CALL EMITBYTE 139
CALL CREG16 %1
CALL RPN! _%MRM%_%REG%_8*+
CALL EMITBYTE %RESULT%
IF %DISPBYTES%==1 CALL EMITBYTE %3
IF %DISPBYTES%==2 CALL EMITWORD %3
GOTO :EOF

:REG8
IF x%2==xBYTE GOTO :R8IMM
IF x%1x%2==xALx[WORD] GOTO :ALADDR
CALL ISMRM8 %2
IF %RESULT%==1 GOTO :R8MRM
ECHO Expected immediate or ModR/M in second operand (IP=%IP%)

:R8IMM
CALL RPN! _%IP%_2+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
CALL IS8SIGN %3
IF %RESULT%==1 GOTO :NOCHECK2
ECHO Byte immediate truncated (IP=%IP%)
:NOCHECK2
CALL CREG8 %1
CALL RPN! _176_%REG%+
CALL EMITBYTE %RESULT%
CALL EMITBYTE %3
GOTO :EOF

:ALADDR
CALL RPN! _%IP%_3+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
CALL EMITBYTE 160
CALL EMITWORD %3
GOTO :EOF

:R8MRM
CALL CMRM8 %2
CALL RPN! _%IP%_2+_%DISPBYTES%+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
IF NOT %DISPBYTES%==1 GOTO :NOCHECK3
CALL IS8SIGN %3
IF %RESULT%==1 GOTO :NOCHECK3
ECHO Byte displacement truncated (IP=%IP%)
:NOCHECK3
CALL EMITBYTE 138
CALL CREG8 %1
CALL RPN! _%MRM%_%REG%_8*+
CALL EMITBYTE %RESULT%
IF %DISPBYTES%==1 CALL EMITBYTE %3
IF %DISPBYTES%==2 CALL EMITWORD %3
GOTO :EOF

:MRM
IF x%1x%3==x[WORD]xAX GOTO :ADDRAX
IF x%1x%3==x[WORD]xAL GOTO :ADDRAL
CALL CMRM16 %1
IF %DISPBYTES%==0 GOTO :MRM2
GOTO :MRM3

:MRM2
CALL ISREG8 %2
IF %RESULT%==1 GOTO :MRM2R8
CALL ISREG16 %2
IF %RESULT%==1 GOTO :MRM2R16
CALL ISREGSEG %2
IF %RESULT%==1 GOTO :MRM2SEG
IF x%2==xWORD GOTO :MRM2I16
IF x%2==xBYTE GOTO :MRM2I8
ECHO Expected register, segment register or immediate in second operand (IP=%IP%)

:MRM3
CALL ISREG8 %3
IF %RESULT%==1 GOTO :MRM3R8
CALL ISREG16 %3
IF %RESULT%==1 GOTO :MRM3R16
CALL ISREGSEG %3
IF %RESULT%==1 GOTO :MRM3SEG
IF x%3==xWORD GOTO :MRM3I16
IF x%3==xBYTE GOTO :MRM3I8
ECHO Expected register, segment register or immediate in second operand (IP=%IP%)

:MRM2R8
CALL CMRM8 %1
CALL RPN! _%IP%_2+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
CALL EMITBYTE 136
CALL CREG8 %2
CALL RPN! _%MRM%_%REG%_8*+
CALL EMITBYTE %RESULT%
GOTO :EOF

:MRM3R8
CALL CMRM8 %1
CALL RPN! _%IP%_2+_%DISPBYTES%+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
IF NOT %DISPBYTES%==1 GOTO :NOCHECK4
CALL IS8SIGN %2
IF %RESULT%==1 GOTO :NOCHECK4
ECHO Byte displacement truncated (IP=%IP%)
:NOCHECK4
CALL EMITBYTE 136
CALL CREG8 %3
CALL RPN! _%MRM%_%REG%_8*+
CALL EMITBYTE %RESULT%
IF %DISPBYTES%==1 CALL EMITBYTE %2
IF %DISPBYTES%==2 CALL EMITWORD %2
GOTO :EOF

:MRM2R16
CALL RPN! _%IP%_2+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
CALL EMITBYTE 137
CALL CREG16 %2
CALL RPN! _%MRM%_%REG%_8*+
CALL EMITBYTE %RESULT%
GOTO :EOF

:MRM3R16
CALL RPN! _%IP%_2+_%DISPBYTES%+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
IF NOT %DISPBYTES%==1 GOTO :NOCHECK5
CALL IS8SIGN %2
IF %RESULT%==1 GOTO :NOCHECK5
ECHO Byte displacement truncated (IP=%IP%)
:NOCHECK5
CALL EMITBYTE 137
CALL CREG16 %3
CALL RPN! _%MRM%_%REG%_8*+
CALL EMITBYTE %RESULT%
IF %DISPBYTES%==1 CALL EMITBYTE %2
IF %DISPBYTES%==2 CALL EMITWORD %2
GOTO :EOF

:MRM2I8
CALL RPN! _%IP%_3+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
CALL IS8SIGN %3
IF %RESULT%==1 GOTO :NOCHECK6
ECHO Byte immediate truncated (IP=%IP%)
:NOCHECK6
CALL EMITBYTE 198
CALL EMITBYTE %MRM%
CALL EMITBYTE %3
GOTO :EOF

:MRM3I8
CALL RPN! _%IP%_3+_%DISPBYTES%+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
IF NOT %DISPBYTES%==1 GOTO :NOCHECK7
CALL IS8SIGN %2
IF %RESULT%==1 GOTO :NOCHECK7
ECHO Byte displacement truncated (IP=%IP%)
:NOCHECK7
CALL IS8SIGN %4
IF %RESULT%==1 GOTO :NOCHECK8
ECHO Byte immediate truncated (IP=%IP%)
:NOCHECK8
CALL EMITBYTE 198
CALL EMITBYTE %MRM%
IF %DISPBYTES%==1 CALL EMITBYTE %2
IF %DISPBYTES%==2 CALL EMITWORD %2
CALL EMITBYTE %4
GOTO :EOF

:MRM2I16
CALL RPN! _%IP%_4+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
CALL EMITBYTE 199
CALL EMITBYTE %MRM%
CALL EMITWORD %3
GOTO :EOF

:MRM3I16
CALL RPN! _%IP%_4+_%DISPBYTES%+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
IF NOT %DISPBYTES%==1 GOTO :NOCHECK9
CALL IS8SIGN %2
IF %RESULT%==1 GOTO :NOCHECK9
ECHO Byte displacement truncated (IP=%IP%)
:NOCHECK9
CALL EMITBYTE 199
CALL EMITBYTE %MRM%
IF %DISPBYTES%==1 CALL EMITBYTE %2
IF %DISPBYTES%==2 CALL EMITWORD %2
CALL EMITWORD %4
GOTO :EOF

:MRM2SEG
CALL CMRM16 %1
CALL RPN! _%IP%_2+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
CALL CREGSEG %2
CALL EMITBYTE 140
CALL RPN! _%MRM%_%REG%_8*+
CALL EMITBYTE %RESULT%
GOTO :EOF

:MRM3SEG
CALL RPN! _%IP%_2+_%DISPBYTES%+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
IF NOT %DISPBYTES%==1 GOTO :NOCHECKA
CALL IS8SIGN %2
IF %RESULT%==1 GOTO :NOCHECKA
ECHO Byte displacement truncated (IP=%IP%)
:NOCHECKA
CALL CREGSEG %3
CALL EMITBYTE 140
CALL RPN! _%MRM%_%REG%_8*+
CALL EMITBYTE %RESULT%
IF %DISPBYTES%==1 CALL EMITBYTE %2
IF %DISPBYTES%==2 CALL EMITWORD %2
GOTO :EOF

:ADDRAX
CALL RPN! _%IP%_3+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
CALL EMITBYTE 163
CALL EMITWORD %2
GOTO :EOF

:ADDRAL
CALL RPN! _%IP%_3+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
CALL EMITBYTE 162
CALL EMITWORD %2
GOTO :EOF

:REGSEG
CALL CMRM16 %2
CALL RPN! _%IP%_2+_%DISPBYTES%+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
IF NOT %DISPBYTES%==1 GOTO :NOCHECKB
CALL IS8SIGN %3
IF %RESULT%==1 GOTO :NOCHECKB
ECHO Byte displacement truncated (IP=%IP%)
:NOCHECKB
CALL EMITBYTE 142
CALL CREGSEG %1
CALL RPN! _%MRM%_%REG%_8*+
CALL EMITBYTE %RESULT%
IF %DISPBYTES%==1 CALL EMITBYTE %2
IF %DISPBYTES%==2 CALL EMITWORD %2
GOTO :EOF

:EOF
